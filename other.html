<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График сотрудников</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .schedule-cell {
            transition: all 0.2s ease;
        }
        .schedule-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .status-working {
            background-color: #d9f99d;
        }
        .status-dayoff {
            background-color: #fecaca;
        }
        .status-overtime {
            background-color: #bfdbfe;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .fade-in {
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .day-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .day-name {
            font-weight: bold;
        }
        .day-date {
            font-size: 0.8rem;
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Главный контейнер -->
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Шапка с заголовком и кнопкой входа -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-800">График работы сотрудников</h1>
            <button id="loginBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                Вход для администратора
            </button>
        </header>

        <!-- Клиентская часть (видима всем) -->
        <section id="clientView" class="mb-12">
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div class="w-full md:w-auto">
                        <label for="employeeSelect" class="block text-sm font-medium text-gray-700 mb-1">Сотрудник:</label>
                        <select id="employeeSelect" class="w-full md:w-64 border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="all">Все сотрудники</option>
                        </select>
                    </div>
                    
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <button id="prevWeek" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h2 id="weekDisplay" class="text-xl font-semibold text-gray-800 min-w-[200px] text-center">Неделя с ...</h2>
                        <button id="nextWeek" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="scheduleTable" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-3 px-4 text-left border-b border-gray-200">Сотрудник</th>
                                <!-- Дни недели будут добавлены динамически -->
                            </tr>
                        </thead>
                        <tbody id="scheduleBody">
                            <!-- Здесь будет динамически заполняться график -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Административная часть (скрыта до входа) -->
        <section id="adminView" class="hidden">
            <div class="bg-white rounded-xl shadow-md p-6 mb-8">
                <h2 class="text-2xl font-bold text-indigo-800 mb-6">Управление графиком</h2>
                
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4">
                        <button id="adminPrevWeek" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="adminWeekDisplay" class="text-xl font-semibold text-gray-800 min-w-[200px] text-center">Неделя с ...</h3>
                        <button id="adminNextWeek" class="bg-gray-200 hover:bg-gray-300 p-2 rounded-full transition">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <button id="saveScheduleBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                </div>
                
                <div class="overflow-x-auto mb-8">
                    <table id="adminScheduleTable" class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-3 px-4 text-left border-b border-gray-200">Сотрудник</th>
                                <!-- Дни недели будут добавлены динамически -->
                            </tr>
                        </thead>
                        <tbody id="adminScheduleBody">
                            <!-- Здесь будет динамически заполняться график для админа -->
                        </tbody>
                    </table>
                </div>
                
                <h3 class="text-xl font-bold text-indigo-800 mb-4">Управление сотрудниками</h3>
                
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input id="newEmployeeName" type="text" placeholder="Имя нового сотрудника" class="flex-1 border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="addEmployeeBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                        <i class="fas fa-user-plus"></i> Добавить
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="py-3 px-4 text-left border-b border-gray-200">ID</th>
                                <th class="py-3 px-4 text-left border-b border-gray-200">Имя</th>
                                <th class="py-3 px-4 text-left border-b border-gray-200">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="employeesList">
                            <!-- Здесь будет список сотрудников -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition flex items-center gap-2">
                <i class="fas fa-sign-out-alt"></i> Выйти
            </button>
        </section>
    </div>

    <!-- Модальное окно входа -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <h2 class="text-2xl font-bold text-indigo-800 mb-6">Вход для администратора</h2>
            
            <div class="mb-4">
                <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                <input id="loginEmail" type="email" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            
            <div class="mb-6">
                <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-1">Пароль:</label>
                <input id="loginPassword" type="password" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            
            <div class="flex justify-end gap-3">
                <button id="cancelLogin" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                    Отмена
                </button>
                <button id="confirmLogin" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                    Войти
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно овертайма -->
    <div id="overtimeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <h2 class="text-2xl font-bold text-indigo-800 mb-6">Настройка овертайма</h2>
            
            <div class="mb-4">
                <label for="overtimeStart" class="block text-sm font-medium text-gray-700 mb-1">Начало:</label>
                <input id="overtimeStart" type="time" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            
            <div class="mb-6">
                <label for="overtimeEnd" class="block text-sm font-medium text-gray-700 mb-1">Конец:</label>
                <input id="overtimeEnd" type="time" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            
            <div class="flex justify-end gap-3">
                <button id="cancelOvertime" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                    Отмена
                </button>
                <button id="saveOvertime" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования сотрудника -->
    <div id="editEmployeeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md fade-in">
            <h2 class="text-2xl font-bold text-indigo-800 mb-6">Редактирование сотрудника</h2>
            
            <div class="mb-6">
                <label for="editEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">Имя:</label>
                <input id="editEmployeeName" type="text" class="w-full border border-gray-300 rounded-md py-2 px-3 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            
            <div class="flex justify-end gap-3">
                <button id="cancelEditEmployee" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                    Отмена
                </button>
                <button id="saveEditEmployee" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <script>
        // Конфигурация Supabase
        const supabaseUrl = 'https://brhrqswautuamwkworrf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyaHJxc3dhdXR1YW13a3dvcnJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MjU5NzUsImV4cCI6MjA2MTQwMTk3NX0.AsHiUVQhMMQPmUL4JpZOSrJ_qkM2jobVbLI4xIOsjwo';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Состояние приложения
        const state = {
            currentWeek: 0, // 0 - текущая неделя, -1 - предыдущая и т.д.
            selectedEmployee: 'all',
            employees: [],
            schedule: {},
            currentUser: null,
            editingEmployeeId: null,
            overtimeEditing: { employeeId: null, day: null },
            weekDates: [] // Массив дат для текущей недели
        };

        // DOM элементы
        const elements = {
            app: document.getElementById('app'),
            clientView: document.getElementById('clientView'),
            adminView: document.getElementById('adminView'),
            employeeSelect: document.getElementById('employeeSelect'),
            weekDisplay: document.getElementById('weekDisplay'),
            adminWeekDisplay: document.getElementById('adminWeekDisplay'),
            scheduleBody: document.getElementById('scheduleBody'),
            adminScheduleBody: document.getElementById('adminScheduleBody'),
            scheduleTable: document.getElementById('scheduleTable'),
            adminScheduleTable: document.getElementById('adminScheduleTable'),
            prevWeek: document.getElementById('prevWeek'),
            nextWeek: document.getElementById('nextWeek'),
            adminPrevWeek: document.getElementById('adminPrevWeek'),
            adminNextWeek: document.getElementById('adminNextWeek'),
            loginBtn: document.getElementById('loginBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            loginModal: document.getElementById('loginModal'),
            loginEmail: document.getElementById('loginEmail'),
            loginPassword: document.getElementById('loginPassword'),
            cancelLogin: document.getElementById('cancelLogin'),
            confirmLogin: document.getElementById('confirmLogin'),
            saveScheduleBtn: document.getElementById('saveScheduleBtn'),
            newEmployeeName: document.getElementById('newEmployeeName'),
            addEmployeeBtn: document.getElementById('addEmployeeBtn'),
            employeesList: document.getElementById('employeesList'),
            overtimeModal: document.getElementById('overtimeModal'),
            overtimeStart: document.getElementById('overtimeStart'),
            overtimeEnd: document.getElementById('overtimeEnd'),
            cancelOvertime: document.getElementById('cancelOvertime'),
            saveOvertime: document.getElementById('saveOvertime'),
            editEmployeeModal: document.getElementById('editEmployeeModal'),
            editEmployeeName: document.getElementById('editEmployeeName'),
            cancelEditEmployee: document.getElementById('cancelEditEmployee'),
            saveEditEmployee: document.getElementById('saveEditEmployee')
        };

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', async () => {
            // Проверяем, авторизован ли пользователь
            const session = await supabase.auth.getSession();
            if (session.data.session) {
                state.currentUser = session.data.session.user;
                showAdminView();
            }
            
            await loadEmployees();
            await loadSchedule();
            updateWeekDisplay();
            renderSchedule();
            
            setupEventListeners();
        });

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Клиентская часть
            elements.employeeSelect.addEventListener('change', (e) => {
                state.selectedEmployee = e.target.value;
                renderSchedule();
            });
            
            elements.prevWeek.addEventListener('click', () => {
                state.currentWeek--;
                updateWeekDisplay();
                loadSchedule().then(renderSchedule);
            });
            
            elements.nextWeek.addEventListener('click', () => {
                state.currentWeek++;
                updateWeekDisplay();
                loadSchedule().then(renderSchedule);
            });
            
            // Админская часть
            elements.adminPrevWeek.addEventListener('click', () => {
                state.currentWeek--;
                updateWeekDisplay();
                loadSchedule().then(renderSchedule);
            });
            
            elements.adminNextWeek.addEventListener('click', () => {
                state.currentWeek++;
                updateWeekDisplay();
                loadSchedule().then(renderSchedule);
            });
            
            elements.loginBtn.addEventListener('click', () => {
                elements.loginModal.classList.remove('hidden');
            });
            
            elements.cancelLogin.addEventListener('click', () => {
                elements.loginModal.classList.add('hidden');
            });
            
            elements.confirmLogin.addEventListener('click', async () => {
                const email = elements.loginEmail.value;
                const password = elements.loginPassword.value;
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    alert('Ошибка входа: ' + error.message);
                    return;
                }
                
                state.currentUser = data.user;
                elements.loginModal.classList.add('hidden');
                showAdminView();
                await loadSchedule();
                renderSchedule();
            });
            
            elements.logoutBtn.addEventListener('click', async () => {
                await supabase.auth.signOut();
                state.currentUser = null;
                hideAdminView();
            });
            
            elements.saveScheduleBtn.addEventListener('click', async () => {
                await saveSchedule();
                alert('График сохранен!');
            });
            
            elements.addEmployeeBtn.addEventListener('click', async () => {
                const name = elements.newEmployeeName.value.trim();
                if (!name) return;
                
                const { data, error } = await supabase
                    .from('employees')
                    .insert([{ name }])
                    .select();
                
                if (error) {
                    alert('Ошибка при добавлении сотрудника: ' + error.message);
                    return;
                }
                
                elements.newEmployeeName.value = '';
                await loadEmployees();
                await loadSchedule();
                renderSchedule();
            });
            
            elements.cancelOvertime.addEventListener('click', () => {
                elements.overtimeModal.classList.add('hidden');
            });
            
            elements.saveOvertime.addEventListener('click', async () => {
                const { employeeId, day } = state.overtimeEditing;
                const start = elements.overtimeStart.value;
                const end = elements.overtimeEnd.value;
                
                if (!start || !end) {
                    alert('Укажите время начала и конца овертайма');
                    return;
                }
                
                // Обновляем статус в локальном состоянии
                const weekKey = getWeekKey();
                if (!state.schedule[weekKey]) state.schedule[weekKey] = {};
                if (!state.schedule[weekKey][employeeId]) state.schedule[weekKey][employeeId] = {};
                
                state.schedule[weekKey][employeeId][day] = {
                    status: 'overtime',
                    overtime_start: start,
                    overtime_end: end
                };
                
                elements.overtimeModal.classList.add('hidden');
                renderSchedule();
            });
            
            elements.cancelEditEmployee.addEventListener('click', () => {
                elements.editEmployeeModal.classList.add('hidden');
            });
            
            elements.saveEditEmployee.addEventListener('click', async () => {
                const name = elements.editEmployeeName.value.trim();
                if (!name || !state.editingEmployeeId) return;
                
                const { error } = await supabase
                    .from('employees')
                    .update({ name })
                    .eq('id', state.editingEmployeeId);
                
                if (error) {
                    alert('Ошибка при обновлении сотрудника: ' + error.message);
                    return;
                }
                
                elements.editEmployeeModal.classList.add('hidden');
                await loadEmployees();
                renderSchedule();
            });
        }

        // Показать админскую часть
        function showAdminView() {
            elements.clientView.classList.add('hidden');
            elements.adminView.classList.remove('hidden');
            elements.loginBtn.classList.add('hidden');
        }

        // Скрыть админскую часть
        function hideAdminView() {
            elements.clientView.classList.remove('hidden');
            elements.adminView.classList.add('hidden');
            elements.loginBtn.classList.remove('hidden');
        }

        // Загрузка списка сотрудников
        async function loadEmployees() {
            const { data, error } = await supabase
                .from('employees')
                .select('*')
                .order('name', { ascending: true });
            
            if (error) {
                console.error('Ошибка при загрузке сотрудников:', error);
                return;
            }
            
            state.employees = data;
            
            // Обновляем выпадающий список
            elements.employeeSelect.innerHTML = '<option value="all">Все сотрудники</option>';
            data.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = employee.name;
                elements.employeeSelect.appendChild(option);
            });
            
            // Обновляем список сотрудников в админке
            elements.employeesList.innerHTML = '';
            data.forEach(employee => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                row.innerHTML = `
                    <td class="py-3 px-4">${employee.id}</td>
                    <td class="py-3 px-4">${employee.name}</td>
                    <td class="py-3 px-4 flex gap-2">
                        <button class="edit-employee-btn bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200 transition" data-id="${employee.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-employee-btn bg-red-100 text-red-800 px-3 py-1 rounded hover:bg-red-200 transition" data-id="${employee.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                elements.employeesList.appendChild(row);
            });
            
            // Добавляем обработчики для кнопок редактирования и удаления
            document.querySelectorAll('.edit-employee-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    editEmployee(id);
                });
            });
            
            document.querySelectorAll('.delete-employee-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    if (confirm(`Удалить сотрудника ${state.employees.find(e => e.id == id).name}?`)) {
                        await deleteEmployee(id);
                    }
                });
            });
        }

        // Редактирование сотрудника
        function editEmployee(id) {
            const employee = state.employees.find(e => e.id == id);
            if (!employee) return;
            
            state.editingEmployeeId = id;
            elements.editEmployeeName.value = employee.name;
            elements.editEmployeeModal.classList.remove('hidden');
        }

        // Удаление сотрудника
        async function deleteEmployee(id) {
            // Удаляем график сотрудника
            const weekKey = getWeekKey();
            if (state.schedule[weekKey] && state.schedule[weekKey][id]) {
                delete state.schedule[weekKey][id];
            }
            
            // Удаляем сотрудника из базы
            const { error } = await supabase
                .from('employees')
                .delete()
                .eq('id', id);
            
            if (error) {
                alert('Ошибка при удалении сотрудника: ' + error.message);
                return;
            }
            
            await loadEmployees();
            await loadSchedule();
            renderSchedule();
        }

        // Загрузка графика
        async function loadSchedule() {
            const weekKey = getWeekKey();
            
            // Генерируем даты для текущей недели
            generateWeekDates();
            
            // Проверяем, есть ли данные в локальном состоянии
            if (state.schedule[weekKey]) return;
            
            // Загружаем данные из Supabase
            const { data, error } = await supabase
                .from('schedule')
                .select('*')
                .eq('week_start', getWeekStartDate().toISOString().split('T')[0]);
            
            if (error) {
                console.error('Ошибка при загрузке графика:', error);
                return;
            }
            
            // Формируем структуру данных для графика
            state.schedule[weekKey] = {};
            data.forEach(record => {
                if (!state.schedule[weekKey][record.employee_id]) {
                    state.schedule[weekKey][record.employee_id] = {};
                }
                
                state.schedule[weekKey][record.employee_id][record.day] = {
                    status: record.status,
                    overtime_start: record.overtime_start,
                    overtime_end: record.overtime_end
                };
            });
        }

        // Генерация дат для текущей недели
        function generateWeekDates() {
            state.weekDates = [];
            const weekStart = getWeekStartDate();
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                state.weekDates.push(date);
            }
        }

        // Сохранение графика
        async function saveSchedule() {
            const weekKey = getWeekKey();
            const weekStart = getWeekStartDate().toISOString().split('T')[0];
            
            // Сначала удаляем старые записи за эту неделю
            const { error: deleteError } = await supabase
                .from('schedule')
                .delete()
                .eq('week_start', weekStart);
            
            if (deleteError) {
                alert('Ошибка при сохранении графика: ' + deleteError.message);
                return;
            }
            
            // Подготавливаем данные для вставки
            const recordsToInsert = [];
            
            for (const employeeId in state.schedule[weekKey]) {
                for (const day in state.schedule[weekKey][employeeId]) {
                    const record = state.schedule[weekKey][employeeId][day];
                    
                    recordsToInsert.push({
                        employee_id: employeeId,
                        week_start: weekStart,
                        day: day,
                        status: record.status,
                        overtime_start: record.overtime_start || null,
                        overtime_end: record.overtime_end || null
                    });
                }
            }
            
            // Вставляем новые записи
            const { error: insertError } = await supabase
                .from('schedule')
                .insert(recordsToInsert);
            
            if (insertError) {
                alert('Ошибка при сохранении графика: ' + insertError.message);
            }
        }

        // Обновление отображения текущей недели
        function updateWeekDisplay() {
            const weekStart = getWeekStartDate();
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const options = { day: 'numeric', month: 'long' };
            const weekStartStr = weekStart.toLocaleDateString('ru-RU', options);
            const weekEndStr = weekEnd.toLocaleDateString('ru-RU', options);
            
            elements.weekDisplay.textContent = `Неделя с ${weekStartStr} по ${weekEndStr}`;
            elements.adminWeekDisplay.textContent = `Неделя с ${weekStartStr} по ${weekEndStr}`;
        }

        // Получение даты начала текущей недели
        function getWeekStartDate() {
            const date = new Date();
            date.setDate(date.getDate() + state.currentWeek * 7);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1); // Первый день недели - понедельник
            return new Date(date.setDate(diff));
        }

        // Ключ для хранения графика в состоянии
        function getWeekKey() {
            return getWeekStartDate().toISOString().split('T')[0];
        }

        // Отрисовка графика
        function renderSchedule() {
            const weekKey = getWeekKey();
            
            // Очищаем таблицы
            elements.scheduleBody.innerHTML = '';
            elements.adminScheduleBody.innerHTML = '';
            
            // Очищаем заголовки дней недели
            const clientThead = elements.scheduleTable.querySelector('thead tr');
            const adminThead = elements.adminScheduleTable.querySelector('thead tr');
            
            // Оставляем только первый столбец (сотрудники)
            while (clientThead.children.length > 1) clientThead.removeChild(clientThead.lastChild);
            while (adminThead.children.length > 1) adminThead.removeChild(adminThead.lastChild);
            
            // Добавляем заголовки дней недели с датами
            state.weekDates.forEach(date => {
                const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
                const dayName = dayNames[date.getDay() === 0 ? 6 : date.getDay() - 1]; // Корректировка для воскресенья
                const dayDate = date.getDate();
                
                const thClient = document.createElement('th');
                thClient.className = 'py-3 px-4 border-b border-gray-200';
                thClient.innerHTML = `
                    <div class="day-header">
                        <span class="day-name">${dayName}</span>
                        <span class="day-date">${dayDate}</span>
                    </div>
                `;
                clientThead.appendChild(thClient);
                
                const thAdmin = document.createElement('th');
                thAdmin.className = 'py-3 px-4 border-b border-gray-200';
                thAdmin.innerHTML = `
                    <div class="day-header">
                        <span class="day-name">${dayName}</span>
                        <span class="day-date">${dayDate}</span>
                    </div>
                `;
                adminThead.appendChild(thAdmin);
            });
            
            // Фильтруем сотрудников, если выбран конкретный
            const employeesToShow = state.selectedEmployee === 'all' 
                ? state.employees 
                : state.employees.filter(e => e.id == state.selectedEmployee);
            
            // Отрисовываем график для каждого сотрудника
            employeesToShow.forEach(employee => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200';
                
                // Ячейка с именем сотрудника
                const nameCell = document.createElement('td');
                nameCell.className = 'py-3 px-4';
                nameCell.textContent = employee.name;
                row.appendChild(nameCell);
                
                // Ячейки с днями недели
                state.weekDates.forEach(dayDate => {
                    const dayKey = dayDate.toISOString().split('T')[0];
                    let status = 'dayoff'; // По умолчанию выходной
                    
                    if (state.schedule[weekKey] && state.schedule[weekKey][employee.id] && state.schedule[weekKey][employee.id][dayKey]) {
                        status = state.schedule[weekKey][employee.id][dayKey].status;
                    }
                    
                    const dayCell = document.createElement('td');
                    dayCell.className = 'py-3 px-4 text-center';
                    
                    if (state.currentUser) {
                        // Админский интерфейс - кликабельные ячейки
                        dayCell.className += ' schedule-cell cursor-pointer';
                        dayCell.setAttribute('data-employee', employee.id);
                        dayCell.setAttribute('data-day', dayKey);
                        
                        switch (status) {
                            case 'working':
                                dayCell.className += ' status-working';
                                dayCell.innerHTML = '<i class="fas fa-briefcase"></i>';
                                break;
                            case 'overtime':
                                dayCell.className += ' status-overtime';
                                const overtime = state.schedule[weekKey][employee.id][dayKey];
                                dayCell.innerHTML = `
                                    <i class="fas fa-clock"></i>
                                    <div class="text-xs mt-1">${overtime.overtime_start}-${overtime.overtime_end}</div>
                                `;
                                break;
                            default:
                                dayCell.className += ' status-dayoff';
                                dayCell.innerHTML = '<i class="fas fa-umbrella-beach"></i>';
                        }
                        
                        dayCell.addEventListener('click', () => {
                            handleAdminCellClick(employee.id, dayKey, status);
                        });
                    } else {
                        // Клиентский интерфейс - только просмотр
                        switch (status) {
                            case 'working':
                                dayCell.className += ' status-working';
                                dayCell.innerHTML = '<i class="fas fa-briefcase"></i>';
                                break;
                            case 'overtime':
                                dayCell.className += ' status-overtime';
                                const overtime = state.schedule[weekKey][employee.id][dayKey];
                                dayCell.innerHTML = `
                                    <i class="fas fa-clock"></i>
                                    <div class="text-xs mt-1">${overtime.overtime_start}-${overtime.overtime_end}</div>
                                `;
                                break;
                            default:
                                dayCell.className += ' status-dayoff';
                                dayCell.innerHTML = '<i class="fas fa-umbrella-beach"></i>';
                        }
                    }
                    
                    row.appendChild(dayCell);
                });
                
                if (state.currentUser) {
                    elements.adminScheduleBody.appendChild(row);
                } else {
                    elements.scheduleBody.appendChild(row);
                }
            });
        }

        // Обработка клика по ячейке в админке
        function handleAdminCellClick(employeeId, day, currentStatus) {
            const weekKey = getWeekKey();
            
            if (!state.schedule[weekKey]) state.schedule[weekKey] = {};
            if (!state.schedule[weekKey][employeeId]) state.schedule[weekKey][employeeId] = {};
            
            let newStatus;
            
            switch (currentStatus) {
                case 'dayoff':
                    newStatus = 'working';
                    state.schedule[weekKey][employeeId][day] = { status: newStatus };
                    break;
                case 'working':
                    newStatus = 'overtime';
                    state.overtimeEditing = { employeeId, day };
                    elements.overtimeStart.value = '';
                    elements.overtimeEnd.value = '';
                    elements.overtimeModal.classList.remove('hidden');
                    return;
                case 'overtime':
                    newStatus = 'dayoff';
                    delete state.schedule[weekKey][employeeId][day];
                    break;
                default:
                    newStatus = 'working';
                    state.schedule[weekKey][employeeId][day] = { status: newStatus };
            }
            
            renderSchedule();
        }
    </script>
</body>
</html>
