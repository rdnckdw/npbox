<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>График сотрудников</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Заголовок и кнопка админ-панели -->
        <div class="flex justify-between mb-6">
            <h1 class="text-2xl font-bold text-indigo-700">График сотрудников</h1>
            <button id="admin-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Админ-панель</button>
        </div>

        <!-- Выбор сотрудника и переключение недель -->
        <div class="flex items-center space-x-4 mb-6">
            <select id="employee-select" class="border rounded-lg p-2"></select>
            <button id="prev-week" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-full"><i class="fas fa-chevron-left"></i></button>
            <div id="week-display" class="font-semibold"></div>
            <button id="next-week" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-full"><i class="fas fa-chevron-right"></i></button>
        </div>

        <!-- Вкладки админ-панели -->
        <div id="admin-tabs" class="hidden mb-4 space-x-4">
            <button id="tab-schedule" class="bg-indigo-500 text-white px-4 py-2 rounded">График</button>
            <button id="tab-employees" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Сотрудники</button>
            <button id="tab-overtime" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Овертаймы</button>
            <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg">Выйти из админки</button>
        </div>

        <!-- Контейнер для графика сотрудников -->
        <div id="schedule-container" class="bg-white shadow rounded-lg overflow-x-auto"></div>
        <div id="admin-content"></div>
    </div>

    <!-- Модальное окно для входа -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
        <div class="bg-white p-6 rounded-lg w-80 space-y-4">
            <h2 class="text-xl font-bold">Вход в админ-панель</h2>
            <input id="login-username" type="text" placeholder="Логин" class="border p-2 w-full rounded-lg">
            <input id="login-password" type="password" placeholder="Пароль" class="border p-2 w-full rounded-lg">
            <button id="login-submit" class="w-full bg-green-600 text-white py-2 rounded-lg">Войти</button>
            <button id="login-cancel" class="w-full bg-gray-300 py-2 rounded-lg">Отмена</button>
            <p id="login-error" class="text-red-500 text-center hidden">Неверный логин или пароль!</p>
        </div>
    </div>

    <script>
        // Конфигурация Supabase
        const SUPABASE_CONFIG = {
            url: 'https://brhrqswautuamwkworrf.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyaHJxc3dhdXR1YW13a3dvcnJmIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NTgyNTk3NSwiZXhwIjoyMDYxNDAxOTc1fQ.HBxafrvjO2-PnrBQp7Obc5dFFZWO_p5DQySUDZu-IfI'
        };

        const App = {
            supabase: null,
            currentWeekStart: null,
            employees: [],
            schedules: {},
            isAdmin: false,
            selectedEmployeeId: 'all',

            // Инициализация приложения
            async init() {
                try {
                    this.supabase = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                    this.currentWeekStart = this.getMonday(new Date());
                    await this.loadEmployees();
                    this.setupEmployeeSelector();
                    await this.loadSchedule(this.currentWeekStart);
                    this.renderSchedule();
                    this.setupNavigation();
                    this.setupAdminLogin();
                    this.setupAdminTabs();
                    console.log('Приложение успешно инициализировано');
                } catch (error) {
                    console.error('Ошибка инициализации приложения:', error);
                }
            },

            // Получаем понедельник текущей недели
            getMonday(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1);
                return new Date(d.setDate(diff));
            },

            // Загрузка сотрудников
            async loadEmployees() {
                try {
                    const { data, error } = await this.supabase
                        .from('employees')
                        .select('*')
                        .order('name', { ascending: true });

                    if (error) throw error;
                    this.employees = data;
                } catch (error) {
                    console.error('Ошибка загрузки сотрудников:', error);
                }
            },

            // Настройка выбора сотрудника
            setupEmployeeSelector() {
                const employeeSelect = document.getElementById('employee-select');
                employeeSelect.innerHTML = '<option value="all">Все сотрудники</option>';

                this.employees.forEach(emp => {
                    const option = document.createElement('option');
                    option.value = emp.id;
                    option.textContent = emp.name;
                    employeeSelect.appendChild(option);
                });

                // Обработчик изменения выбора сотрудника
                employeeSelect.addEventListener('change', (event) => {
                    this.selectedEmployeeId = event.target.value;
                    this.renderSchedule();
                });
            },

            // Загрузка графика
            async loadSchedule(weekStart) {
                try {
                    const start = weekStart.toISOString().split('T')[0];
                    const end = new Date(weekStart.getTime() + 6 * 86400000).toISOString().split('T')[0];

                    const { data, error } = await this.supabase
                        .from('schedule')
                        .select('employee_id, date, is_working, comment')
                        .gte('date', start)
                        .lte('date', end);

                    if (error) throw error;

                    this.schedules = {};
                    this.employees.forEach(e => this.schedules[e.id] = {});

                    data.forEach(r => {
                        if (this.schedules[r.employee_id]) {
                            this.schedules[r.employee_id][r.date] = { isWorking: r.is_working, comment: r.comment };
                        }
                    });
                } catch (error) {
                    console.error('Ошибка загрузки графика:', error);
                }
            },

            // Отображение графика
            renderSchedule() {
                const container = document.getElementById('schedule-container');
                const weekDates = [...Array(7)].map((_, i) => {
                    const day = new Date(this.currentWeekStart.getTime() + i * 86400000);
                    return {
                        date: day.toISOString().split('T')[0],
                        dayName: day.toLocaleDateString('ru-RU', { weekday: 'short' })
                    };
                });

                let html = `<table class="min-w-full"><thead><tr><th class="p-3 text-left">Сотрудник</th>`;
                weekDates.forEach(day => {
                    html += `<th class="p-3 text-center">${day.dayName}<br>${day.date.split('-')[2]}</th>`;
                });
                html += `</tr></thead><tbody>`;

                const employeesToShow = this.selectedEmployeeId === 'all'
                    ? this.employees
                    : this.employees.filter(e => e.id === this.selectedEmployeeId);

                employeesToShow.forEach(emp => {
                    html += `<tr class="border-t"><td class="p-3 font-medium">${emp.name}</td>`;
                    weekDates.forEach(day => {
                        // Если нет статуса, по умолчанию "Работает"
                        const status = this.schedules[emp.id] && this.schedules[emp.id][day.date]
                            ? this.schedules[emp.id][day.date].isWorking ? 'Работает' : 'Отдыхает'
                            : 'Работает'; // Статус по умолчанию
                        const comment = this.schedules[emp.id] && this.schedules[emp.id][day.date]
                            ? this.schedules[emp.id][day.date].comment || '' 
                            : '';

                        if (this.isAdmin) {
                            html += `<td class="p-3 text-center ${status === 'Работает' ? 'bg-green-100' : 'bg-red-100'}"
                                        ondblclick="App.addComment('${emp.id}', '${day.date}')">
                                        ${status} ${comment ? `- ${comment}` : ''}</td>`;
                        } else {
                            html += `<td class="p-3 text-center ${status === 'Работает' ? 'bg-green-100' : 'bg-red-100'}">
                                        ${status} ${comment ? `- ${comment}` : ''}</td>`;
                        }
                    });
                    html += `</tr>`;
                });

                container.innerHTML = html;
                this.updateWeekDisplay();
            },

            // Переключение статуса работы
            async toggleWorkStatus(employeeId, date) {
                const currentStatus = this.schedules[employeeId] && this.schedules[employeeId][date];
                const newStatus = currentStatus ? false : true;

                await this.saveSchedule(employeeId, date, newStatus);
                this.schedules[employeeId][date] = newStatus;
                this.renderSchedule();
            },

            // Сохранение статуса работы
            async saveSchedule(employeeId, date, isWorking) {
                try {
                    // Проверяем, существует ли уже запись для этого сотрудника и этой даты
                    const { data, error } = await this.supabase
                        .from('schedule')
                        .select('employee_id, date')
                        .eq('employee_id', employeeId)
                        .eq('date', date);

                    if (error) throw error;

                    // Если запись существует, обновляем статус
                    if (data.length > 0) {
                        const { updateError } = await this.supabase
                            .from('schedule')
                            .update({ is_working: isWorking })
                            .eq('employee_id', employeeId)
                            .eq('date', date);

                        if (updateError) throw updateError;
                    } else {
                        // Если записи нет, создаем новую
                        const { insertError } = await this.supabase
                            .from('schedule')
                            .insert([{ employee_id: employeeId, date: date, is_working: isWorking }]);

                        if (insertError) throw insertError;
                    }
                } catch (error) {
                    console.error('Ошибка сохранения статуса:', error);
                }
            },

            // Обработчик долгого клика для добавления комментария
            addComment(employeeId, date) {
                const comment = prompt('Введите комментарий:', '');
                if (comment !== null && comment.trim() !== '') {
                    this.saveComment(employeeId, date, comment);
                }
            },

            // Сохранение комментария
            async saveComment(employeeId, date, comment) {
                try {
                    const { data, error } = await this.supabase
                        .from('schedule')
                        .select('employee_id, date')
                        .eq('employee_id', employeeId)
                        .eq('date', date);

                    if (error) throw error;

                    // Если запись существует, обновляем комментарий
                    if (data.length > 0) {
                        const { updateError } = await this.supabase
                            .from('schedule')
                            .update({ comment: comment })
                            .eq('employee_id', employeeId)
                            .eq('date', date);

                        if (updateError) throw updateError;
                    } else {
                        // Если записи нет, создаем новую
                        const { insertError } = await this.supabase
                            .from('schedule')
                            .insert([{ employee_id: employeeId, date: date, comment: comment }]);

                        if (insertError) throw insertError;
                    }
                    this.loadSchedule(this.currentWeekStart); // Перезагружаем график с новым комментарием
                } catch (error) {
                    console.error('Ошибка сохранения комментария:', error);
                }
            },

            // Обновление отображения недели
            updateWeekDisplay() {
                const weekDisplay = document.getElementById('week-display');
                const startDate = new Date(this.currentWeekStart);
                const endDate = new Date(this.currentWeekStart);
                endDate.setDate(startDate.getDate() + 6);
                weekDisplay.textContent = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;
            },

            // Настройка навигации по неделям
            setupNavigation() {
                const prevWeekBtn = document.getElementById('prev-week');
                const nextWeekBtn = document.getElementById('next-week');

                prevWeekBtn.addEventListener('click', () => {
                    this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
                    this.loadSchedule(this.currentWeekStart);
                    this.renderSchedule();
                });

                nextWeekBtn.addEventListener('click', () => {
                    this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
                    this.loadSchedule(this.currentWeekStart);
                    this.renderSchedule();
                });
            },

            // Обработчик входа в админку
            setupAdminLogin() {
                const adminBtn = document.getElementById('admin-btn');
                const loginModal = document.getElementById('login-modal');
                const loginSubmit = document.getElementById('login-submit');
                const loginCancel = document.getElementById('login-cancel');
                const loginError = document.getElementById('login-error');

                adminBtn.addEventListener('click', () => {
                    loginModal.classList.remove('hidden');
                });

                loginCancel.addEventListener('click', () => {
                    loginModal.classList.add('hidden');
                });

                loginSubmit.addEventListener('click', () => {
                    const username = document.getElementById('login-username').value;
                    const password = document.getElementById('login-password').value;

                    // В реальном приложении добавьте проверку пароля и логина
                    if (username === 'admin' && password === 'password') {
                        this.isAdmin = true;
                        loginModal.classList.add('hidden');
                        this.toggleAdminTabs();
                    } else {
                        loginError.classList.remove('hidden');
                    }
                });
            },

            // Показ/скрытие вкладок админ-панели
            toggleAdminTabs() {
                const adminTabs = document.getElementById('admin-tabs');
                adminTabs.classList.remove('hidden');
            },

            // Настройка вкладок админ-панели
            setupAdminTabs() {
                const logoutBtn = document.getElementById('logout-btn');
                logoutBtn.addEventListener('click', () => {
                    this.isAdmin = false;
                    document.getElementById('admin-tabs').classList.add('hidden');
                    this.renderSchedule();
                });
            }
        };

        // Инициализация приложения
        App.init();
    </script>
</body>
</html>
