<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>График сотрудников</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="container mx-auto p-4">
    <div class="flex justify-between mb-6">
      <h1 class="text-2xl font-bold text-indigo-700">График сотрудников</h1>
      <button id="admin-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Админ-панель</button>
    </div>

    <div class="flex items-center space-x-4 mb-6">
      <select id="employee-select" class="border rounded-lg p-2"></select>
      <button id="prev-week" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-full"><i class="fas fa-chevron-left"></i></button>
      <div id="week-display" class="font-semibold"></div>
      <button id="next-week" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-full"><i class="fas fa-chevron-right"></i></button>
    </div>

    <div id="admin-tabs" class="hidden mb-4 space-x-4">
      <button id="tab-schedule" class="bg-indigo-500 text-white px-4 py-2 rounded">График</button>
      <button id="tab-employees" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Сотрудники</button>
      <button id="tab-overtime" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Овертаймы</button>
    </div>

    <div id="schedule-container" class="bg-white shadow rounded-lg overflow-x-auto"></div>
    <div id="admin-content"></div>
  </div>

  <!-- Модальное окно входа -->
  <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-white p-6 rounded-lg w-80 space-y-4">
      <h2 class="text-xl font-bold">Вход в админ-панель</h2>
      <input id="login-username" type="text" placeholder="Логин" class="border p-2 w-full rounded-lg">
      <input id="login-password" type="password" placeholder="Пароль" class="border p-2 w-full rounded-lg">
      <button id="login-submit" class="w-full bg-green-600 text-white py-2 rounded-lg">Войти</button>
      <button id="login-cancel" class="w-full bg-gray-300 py-2 rounded-lg">Отмена</button>
      <p id="login-error" class="text-red-500 text-center hidden">Неверный логин или пароль!</p>
    </div>
  </div>

<script>
// 1. Объявляем конфигурационные переменные
const SUPABASE_CONFIG = {
  url: 'https://brhrqswautuamwkworrf.supabase.co',
  key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJyaHJxc3dhdXR1YW13a3dvcnrfIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU4MjU5NzUsImV4cCI6MjA2MTQwMTk3NX0.AsHiUVQhMMQPmUL4JpZOSrJ_qkM2jobVbLI4xIOsjwo'
};

// 2. Создаем глобальный объект приложения
const App = {
  supabase: null,
  currentWeekStart: null,
  employees: [],
  schedules: {},
  isAdmin: false,
  selectedEmployeeId: 'all',

  // 3. Инициализация приложения
  async init() {
    try {
      // Инициализируем Supabase
      this.supabase = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);

      // Устанавливаем начальную дату
      this.currentWeekStart = this.getMonday(new Date());

      // Загружаем данные и настраиваем UI
      await this.loadEmployees();
      this.setupEmployeeSelector();
      await this.loadSchedule(this.currentWeekStart);
      this.renderSchedule();
      this.setupNavigation();
      this.setupAdminLogin();
      this.setupAdminTabs(); // Убедимся, что вкладки админа настраиваются после логина

      console.log('Приложение успешно инициализировано');
    } catch (error) {
      console.error('Ошибка инициализации приложения:', error);
    }
  },

  // 4. Методы приложения
  getMonday(date) {
    const d = new Date(date);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
  },

  async loadEmployees() {
    try {
      const { data, error } = await this.supabase
        .from('employees')
        .select('*')
        .order('name', { ascending: true });

      if (error) throw error;
      this.employees = data;
    } catch (error) {
      console.error('Ошибка загрузки сотрудников:', error);
    }
  },

  async loadSchedule(weekStart) {
    try {
      const start = weekStart.toISOString().split('T')[0];
      const end = new Date(weekStart.getTime() + 6 * 86400000).toISOString().split('T')[0];

      const { data, error } = await this.supabase
        .from('schedule')
        .select('employee_id, date, is_working')
        .gte('date', start)
        .lte('date', end);

      if (error) throw error;

      this.schedules = {};
      this.employees.forEach(e => this.schedules[e.id] = {});

      data.forEach(r => {
        if (this.schedules[r.employee_id]) {
          this.schedules[r.employee_id][r.date] = r.is_working;
        }
      });
    } catch (error) {
      console.error('Ошибка загрузки графика:', error);
    }
  },

  renderSchedule() {
    const container = document.getElementById('schedule-container');
    const weekDates = [...Array(7)].map((_, i) => {
      const day = new Date(this.currentWeekStart.getTime() + i * 86400000);
      return {
        date: day.toISOString().split('T')[0],
        dayName: day.toLocaleDateString('ru-RU', { weekday: 'short' })
      };
    });

    let html = `<table class="min-w-full"><thead><tr><th class="p-3 text-left">Сотрудник</th>`;
    weekDates.forEach(day => {
      html += `<th class="p-3 text-center">${day.dayName}<br>${day.date.split('-')[2]}</th>`;
    });
    html += `</tr></thead><tbody>`;

    const employeesToShow = this.selectedEmployeeId === 'all'
      ? this.employees
      : this.employees.filter(e => e.id === this.selectedEmployeeId);

    employeesToShow.forEach(emp => {
      html += `<tr class="border-t"><td class="p-3 font-medium">${emp.name}</td>`;
      weekDates.forEach(day => {
        const isWorking = this.schedules[emp.id] && this.schedules[emp.id][day.date];
        const bgColor = isWorking ? 'bg-green-100' : 'bg-red-100';
        const text = isWorking ? 'Работает' : 'Отдыхает';

        if (this.isAdmin) {
          html += `<td class="p-3 text-center ${bgColor}">
            <select class="border rounded p-1" data-employee="${emp.id}" data-date="${day.date}" onchange="App.handleScheduleChange(this)">
              <option value="true" ${isWorking ? 'selected' : ''}>Работает</option>
              <option value="false" ${!isWorking ? 'selected' : ''}>Отдыхает</option>
            </select>
          </td>`;
        } else {
          html += `<td class="p-3 text-center ${bgColor}">${text}</td>`;
        }
      });
      html += `</tr>`;
    });

    if (this.isAdmin) {
      html += `</tbody></table>
        <div class="p-4 text-center">
          <button onclick="App.saveScheduleChanges()" class="bg-green-600 text-white px-6 py-2 rounded">
            Сохранить изменения
          </button>
        </div>`;
    } else {
      html += `</tbody></table>`;
    }

    container.innerHTML = html;
    this.updateWeekDisplay();
  },

  async handleScheduleChange(selectElement) {
    // Можно реализовать немедленное обновление в памяти, если необходимо
    // const employeeId = selectElement.dataset.employee;
    // const date = selectElement.dataset.date;
    // const isWorking = selectElement.value === 'true';
    // if (this.schedules[employeeId] && this.schedules[employeeId][date] !== undefined) {
    //   this.schedules[employeeId][date] = isWorking;
    // }
  },

  async saveScheduleChanges() {
    const selects = document.querySelectorAll('#schedule-container select[data-employee]');
    const updates = [];

    selects.forEach(select => {
      updates.push({
        employee_id: select.dataset.employee,
        date: select.dataset.date,
        is_working: select.value === 'true'
      });
    });

    for (const record of updates) {
      await this.supabase.from('schedule').upsert(record, { onConflict: ['employee_id', 'date'] });
    }

    alert('Изменения сохранены!');
    await this.loadSchedule(this.currentWeekStart);
    this.renderSchedule();
  },

  setupEmployeeSelector() {
    const select = document.getElementById('employee-select');
    select.innerHTML = '<option value="all">Все сотрудники</option>';
    this.employees.forEach(emp => {
      const option = document.createElement('option');
      option.value = emp.id;
      option.textContent = emp.name;
      select.appendChild(option);
    });

    select.addEventListener('change', async (e) => {
      this.selectedEmployeeId = e.target.value;
      await this.loadSchedule(this.currentWeekStart);
      this.renderSchedule();
    });
  },

  setupNavigation() {
    document.getElementById('prev-week').addEventListener('click', async () => {
      this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
      await this.loadSchedule(this.currentWeekStart);
      this.renderSchedule();
    });
    document.getElementById('next-week').addEventListener('click', async () => {
      this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
      await this.loadSchedule(this.currentWeekStart);
      this.renderSchedule();
    });
    this.updateWeekDisplay();
  },

  updateWeekDisplay() {
    const weekStart = this.currentWeekStart.toLocaleDateString('ru-RU');
    const weekEnd = new Date(this.currentWeekStart.getTime() + 6 * 86400000).toLocaleDateString('ru-RU');
    document.getElementById('week-display').textContent = `${weekStart} - ${weekEnd}`;
  },

  setupAdminLogin() {
    document.getElementById('admin-btn').addEventListener('click', () => {
      document.getElementById('login-modal').classList.remove('hidden');
    });
    document.getElementById('login-cancel').addEventListener('click', () => {
      document.getElementById('login-modal').classList.add('hidden');
    });
    document.getElementById('login-submit').addEventListener('click', () => {
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      if (username === 'admin' && password === '1234') {
        this.isAdmin = true;
        document.getElementById('login-modal').classList.add('hidden');
        document.getElementById('admin-tabs').classList.remove('hidden');
        this.renderSchedule();
        this.renderEmployeesAdmin(); // По умолчанию показываем сотрудников после логина
      } else {
        document.getElementById('login-error').classList.remove('hidden');
      }
    });
  },

  setupAdminTabs() {
    const tabSchedule = document.getElementById('tab-schedule');
    const tabEmployees = document.getElementById('tab-employees');
    const tabOvertime = document.getElementById('tab-overtime');
    const adminContent = document.getElementById('admin-content');

    if (tabSchedule) {
      tabSchedule.addEventListener('click', () => {
        this.renderSchedule();
        adminContent.innerHTML = ''; // Очищаем, если что-то было отображено
      });
    }
    if (tabEmployees) {
      tabEmployees.addEventListener('click', () => {
        this.renderEmployeesAdmin();
      });
    }
    if (tabOvertime) {
      tabOvertime.addEventListener('click', () => {
        this.renderOvertimeAdmin();
      });
    }
  },

  renderEmployeesAdmin() {
    const container = document.getElementById('admin-content');
    if (!container) return;
    let html = `
      <h2 class="text-2xl font-bold mb-4">Управление сотрудниками</h2>
      <table class="min-w-full bg-white shadow rounded-lg mb-4">
        <thead><tr><th>ID</th><th>Имя</th><th>Действия</th></tr></thead>
        <tbody>
    `;
    this.employees.forEach(emp => {
      html += `
        <tr class="border-t">
          <td class="px-4 py-2">${emp.id}</td>
          <td class="px-4 py-2">
            <input value="${emp.name}" data-employee-id="${emp.id}" class="border p-1 rounded w-full">
          </td>
          <td class="px-4 py-2 space-x-2">
            <button onclick="App.updateEmployeeName('${emp.id}')" class="text-indigo-600">Сохранить</button>
            <button onclick="App.deleteEmployee('${emp.id}')" class="text-red-600">Удалить</button>
          </td>
        </tr>`;
    });
    html += `</tbody></table>
      <div class="mt-4">
        <input id="new-employee-name" class="border p-2 rounded mr-2" placeholder="Новый сотрудник">
        <button onclick="App.addEmployee()" class="bg-green-600 text-white px-4 py-2 rounded">Добавить</button>
      </div>`;
    container.innerHTML = html;
  },

  async updateEmployeeName(id) {
    const input = document.querySelector(`input[data-employee-id="${id}"]`);
    const newName = input.value.trim();
    if (!newName) return alert('Имя не может быть пустым');
    await this.supabase.from('employees').update({ name: newName }).eq('id', id);
    alert('Имя обновлено!');
    await this.loadEmployees();
    this.renderEmployeesAdmin();
  },

  async deleteEmployee(id) {
    if (!confirm('Удалить сотрудника?')) return;
    await this.supabase.from('employees').delete().eq('id', id);
    alert('Удалено!');
    await this.loadEmployees();
    this.renderEmployeesAdmin();
  },

  async addEmployee() {
    const name = document.getElementById('new-employee-name').value.trim();
    if (!name) return alert('Введите имя');
    await this.supabase.from('employees').insert({ name });
    alert('Сотрудник добавлен!');
    document.getElementById('new-employee-name').value = '';
    await this.loadEmployees();
    this.renderEmployeesAdmin();
  },

  renderOvertimeAdmin() {
    const container = document.getElementById('admin-content');
    if (!container) return;
    let html = `
      <h2 class="text-2xl font-bold mb-4">Учёт овертаймов</h2>
      <table class="min-w-full bg-white shadow rounded-lg mb-4">
        <thead><tr><th>Сотрудник</th><th>Пн</th><th>Вт</th><th>Ср</th><th>Чт</th><th>Пт</th><th>Сб</th><th>Вс</th></tr></thead>
        <tbody>
    `;

    const weekDates = [...Array(7)].map((_, i) => {
      const day = new Date(this.currentWeekStart.getTime() + i * 86400000);
      return day.toISOString().split('T')[0];
    });

    for (let emp of this.employees) {
      html += `<tr><td class="px-4 py-2 font-medium">${emp.name}</td>`;
      for (let date of weekDates) {
        html += `<td class="px-2 py-2 text-center">
          <input type="number" min="0" step="0.5" class="w-16 p-1 border rounded text-center" data-employee="${emp.id}" data-date="${date}">
        </td>`;
      }
      html += `</tr>`;
    }

    html += `</tbody></table>
      <div class="text-center mt-4">
        <button onclick="App.saveOvertimes()" class="bg-green-600 text-white px-6 py-2 rounded">Сохранить овертаймы</button>
      </div>`;

    container.innerHTML = html;
  },

  async saveOvertimes() {
    const inputs = document.querySelectorAll('#admin-content input[data-employee]');
    const updates = [];

    inputs.forEach(inp => {
      updates.push({
        employee_id: inp.dataset.employee,
        date: inp.dataset.date,
        hours: parseFloat(inp.value) || 0
      });
    });

    for (const record of updates) {
      await this.supabase.from('overtime').upsert(record, { onConflict: ['employee_id', 'date'] });
    }

    alert('Овертаймы успешно сохранены!');
  }
};

document.addEventListener('DOMContentLoaded', async () => {
  await App.init();
});
</script>


</body>
</html>
