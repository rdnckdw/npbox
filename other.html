<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–ª–∞–¥ –∫–Ω–∏–≥</title>
    <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f8f8;
            color: #333;
            text-align: center;
        }

        h2 {
            font-weight: 600;
            color: #000;
        }
        nav {
            background: #fff;
            padding: 10px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        nav a {
            text-decoration: none;
            color: #007aff;
            margin: 0 15px;
            font-size: 18px;
        }
        button {
            background: #007aff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #005ecb;
        }
        input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 16px;
        }
        .search-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        table {
            width: 90%;
            margin: 20px auto;
            border-collapse: collapse;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #007aff;
            color: white;
        }
        .edit-btn, .delete-btn {
            cursor: pointer;
            margin: 5px;
        }
        #scanner-container {
            width: 100%;
            height: auto;
            display: none;
            margin-top: 10px;
        }
        video {
            width: 100%;
            border-radius: 10px;
        }
    </style>
    <script>
        let bookDatabase = JSON.parse(localStorage.getItem('bookDatabase')) || {};

        function searchBook() {
            let bookName = document.getElementById("bookName").value.trim();
            let found = Object.entries(bookDatabase).find(([_, book]) => book.name === bookName);
            alert(found ? `–ö–Ω–∏–≥–∞ –Ω–∞–π–¥–µ–Ω–∞! –ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è: ${found[1].location}` : "–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
        }

        function scanBarcodeForShelf() {
            document.getElementById("scanner-container").style.display = "block";
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector("#scanner") },
                decoder: { readers: ["ean_reader", "code_128_reader"] }
            }, function(err) {
                if (!err) Quagga.start();
            });

            Quagga.onDetected(function(result) {
                Quagga.stop();
                document.getElementById("scanner-container").style.display = "none";
                let shelfBarcode = result.codeResult.code;
                document.getElementById("shelfCodeInput").value = shelfBarcode;
            });
        }

        function scanBarcodeForBook() {
            document.getElementById("scanner-container").style.display = "block";
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector("#scanner") },
                decoder: { readers: ["ean_reader", "code_128_reader"] }
            }, function(err) {
                if (!err) Quagga.start();
            });

            Quagga.onDetected(function(result) {
                Quagga.stop();
                document.getElementById("scanner-container").style.display = "none";
                let barcode = result.codeResult.code;
                processBarcode(barcode);
            });
        }

        function processBarcode(barcode) {
            if (bookDatabase[barcode]) {
                alert(`–ö–Ω–∏–≥–∞: ${bookDatabase[barcode].name}\n–ú–µ—Å—Ç–æ: ${bookDatabase[barcode].location}`);
            } else {
                let newBookName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏");
                let newLocation = prompt("–í–≤–µ–¥–∏—Ç–µ –º–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è");
                let shelfCode = document.getElementById("shelfCodeInput").value || prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–ª–∫–∏ –≤—Ä—É—á–Ω—É—é");

                if (newBookName && newLocation && shelfCode) {
                    bookDatabase[barcode] = { name: newBookName, location: newLocation, shelfCode: shelfCode };
                    localStorage.setItem('bookDatabase', JSON.stringify(bookDatabase));
                    loadBooks();
                }
            }
        }

        function saveToCSV() {
            let csvContent = "–®—Ç—Ä–∏—Ö–∫–æ–¥,–ù–∞–∑–≤–∞–Ω–∏–µ,–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è,–ö–æ–¥ –ø–æ–ª–∫–∏\n" +
                Object.entries(bookDatabase).map(([barcode, book]) => `${barcode},${book.name},${book.location},${book.shelfCode}`).join("\n");
            let link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csvContent], { type: "text/csv" }));
            link.download = "books.csv";
            link.click();
        }

        function loadFromCSV(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith(".csv")) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const content = e.target.result;
                    const rows = content.split("\n");
                    rows.slice(1).forEach(row => {
                        const [barcode, name, location, shelfCode] = row.split(",");
                        if (barcode && name && location && shelfCode) {
                            bookDatabase[barcode] = { name, location, shelfCode };
                        }
                    });
                    localStorage.setItem('bookDatabase', JSON.stringify(bookDatabase));
                    loadBooks();
                    alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
                };
                reader.readAsText(file);
            } else {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª CSV.");
            }
        }

        function loadBooks() {
            let table = document.getElementById("bookTableBody");
            table.innerHTML = "";
            Object.entries(bookDatabase).forEach(([barcode, book]) => {
                let row = `<tr>
                    <td>${barcode}</td>
                    <td contenteditable="true" onblur="editBook('${barcode}', this.innerText, 'name')">${book.name}</td>
                    <td contenteditable="true" onblur="editBook('${barcode}', this.innerText, 'location')">${book.location}</td>
                    <td contenteditable="true" onblur="editBook('${barcode}', this.innerText, 'shelfCode')">${book.shelfCode}</td>
                    <td><span class="delete-btn" onclick="deleteBook('${barcode}')">üóë</span></td>
                </tr>`;
                table.innerHTML += row;
            });
        }

        function editBook(barcode, value, field) {
            bookDatabase[barcode][field] = value;
            localStorage.setItem('bookDatabase', JSON.stringify(bookDatabase));
        }

        function deleteBook(barcode) {
            delete bookDatabase[barcode];
            localStorage.setItem('bookDatabase', JSON.stringify(bookDatabase));
            loadBooks();
        }
    </script>
</head>
<body>
  <nav class="navbar">
    <a href="index.html" class="nav-link active">–ö–æ—Ä–æ–±–∫–∏ –ù–ü</a>
    <a href="other.html" class="nav-link">–î—Ä—É–≥–æ–µ</a>
  </nav>
    <nav>
        <a href="#" onclick="document.getElementById('main').style.display='block'; document.getElementById('books').style.display='none';">–ì–ª–∞–≤–Ω–∞—è</a>
        <a href="#" onclick="document.getElementById('main').style.display='none'; document.getElementById('books').style.display='block'; loadBooks();">–°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥</a>
    </nav>
    
    <div id="main">
        <h2>–ü–æ–∏—Å–∫ –∫–Ω–∏–≥–∏</h2>
        <div class="search-container">
            <input type="text" id="bookName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏">
            <button onclick="searchBook()">–ü–æ–∏—Å–∫</button>
        </div>
        <button onclick="scanBarcodeForBook()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É</button>
        <div id="scanner-container">
            <video id="scanner"></video>
        </div>
    </div>
    
    <div id="books" style="display: none;">
        <h2>–°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥</h2>
        <button onclick="saveToCSV()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ CSV</button>
        <input type="file" id="fileInput" accept=".csv" onchange="loadFromCSV(event)">
        <div>
            <label for="shelfCodeInput">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–ª–∫–∏:</label>
            <input type="text" id="shelfCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–ª–∫–∏ –≤—Ä—É—á–Ω—É—é">
            <button onclick="scanBarcodeForShelf()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –ø–æ–ª–∫–∏</button>
        </div>
        <table>
            <thead><tr><th>–®—Ç—Ä–∏—Ö–∫–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ú–µ—Å—Ç–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è</th><th>–ö–æ–¥ –ø–æ–ª–∫–∏</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="bookTableBody"></tbody>
        </table>
    </div>
</body>
</html>
