<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Управление книгами</title>
    <script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .navbar { background: #007aff; padding: 10px; color: white; }
        .nav-link { color: white; margin: 0 15px; text-decoration: none; }
        .tab-container { margin-top: 20px; }
        .tab { display: none; }
        .tab.active { display: block; }
        table { width: 90%; margin: 20px auto; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #007aff; color: white; }
        .scanner-container { display: none; }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="nav-link">Коробки НП</a>
        <a href="other.html" class="nav-link">Другое</a>
    </nav>
    
    <nav>
        <button onclick="switchTab('main')">Главная</button>
        <button onclick="switchTab('books')">Список книг</button>
        <button onclick="switchTab('shelves')">Полки</button>
    </nav>
    
    <div id="main" class="tab active">
        <h2>Поиск книги</h2>
        <input type="text" id="searchInput" placeholder="Введите название или штрихкод">
        <button onclick="searchBook()">Поиск</button>
        <button onclick="scanBarcode()">Сканировать</button>
        <div id="scanner-container" class="scanner-container">
            <video id="scanner"></video>
        </div>
        <table id="searchResults"></table>
    </div>
    
    <div id="books" class="tab">
        <h2>Список книг</h2>
        <button onclick="saveToCSV()">Сохранить в CSV</button>
        <input type="file" id="csvUpload" onchange="loadFromCSV(event)">
        <table>
            <thead><tr><th>Название</th><th>Полка</th><th>Комментарий</th><th>Действия</th></tr></thead>
            <tbody id="bookTableBody"></tbody>
        </table>
    </div>
    
    <div id="shelves" class="tab">
        <h2>Полки</h2>
        <button onclick="scanShelf()">Сканировать полку</button>
        <table>
            <thead><tr><th>Код</th><th>Местоположение</th><th>Действия</th></tr></thead>
            <tbody id="shelvesTableBody"></tbody>
        </table>
    </div>
    
    <script>
        let bookDatabase = JSON.parse(localStorage.getItem('bookDatabase')) || {};
        let shelfDatabase = JSON.parse(localStorage.getItem('shelfDatabase')) || {};

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        function searchBook() {
            let query = document.getElementById("searchInput").value.trim();
            let results = Object.entries(bookDatabase).filter(([barcode, book]) => 
                barcode.includes(query) || book.name.includes(query));
            let table = document.getElementById("searchResults");
            table.innerHTML = "<tr><th>Название</th><th>Полка</th><th>Комментарий</th></tr>" + 
                results.map(([_, book]) => `<tr><td>${book.name}</td><td>${book.shelfCode}</td><td>${book.comment}</td></tr>`).join('');
        }

        function scanBarcode() {
            document.getElementById("scanner-container").style.display = "block";
            Quagga.init({
                inputStream: { type: "LiveStream", target: document.querySelector("#scanner") },
                decoder: { readers: ["ean_reader", "code_128_reader"] }
            }, err => { if (!err) Quagga.start(); });
            Quagga.onDetected(result => {
                let barcode = result.codeResult.code;
                Quagga.stop();
                document.getElementById("scanner-container").style.display = "none";
                processBarcode(barcode);
            });
        }

        function processBarcode(barcode) {
            if (bookDatabase[barcode]) {
                alert(`Книга найдена! Полка: ${bookDatabase[barcode].shelfCode}\nКомментарий: ${bookDatabase[barcode].comment}`);
            } else {
                let name = prompt("Введите название книги");
                let shelfCode = prompt("Введите код полки");
                let comment = prompt("Введите комментарий");
                bookDatabase[barcode] = { name, shelfCode, comment };
                localStorage.setItem('bookDatabase', JSON.stringify(bookDatabase));
                loadBooks();
            }
        }

        function scanShelf() {
            let barcode = prompt("Введите код полки");
            if (!shelfDatabase[barcode]) {
                let location = prompt("Введите местоположение полки");
                shelfDatabase[barcode] = location;
                localStorage.setItem('shelfDatabase', JSON.stringify(shelfDatabase));
            } else {
                alert(`Книги на полке ${barcode}:\n` + 
                    Object.values(bookDatabase).filter(book => book.shelfCode === barcode).map(book => book.name).join("\n"));
            }
        }

        function saveToCSV() {
            let csv = "type,barcode,name,shelfCode,comment\n" + 
                Object.entries(bookDatabase).map(([b, book]) => `Книга,${b},${book.name},${book.shelfCode},${book.comment}`).join("\n") + "\n" +
                Object.entries(shelfDatabase).map(([b, loc]) => `Полка,${b},${loc},,`).join("\n");
            let link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: "text/csv" }));
            link.download = "data.csv";
            link.click();
        }
    </script>
</body>
</html>
